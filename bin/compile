#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir> <env-dir>
# $HOME: /app

# fail fast
set -eu -o pipefail

BUILD_DIR=${1:-.}
CACHE_DIR=${2:-}
LP_DIR=`cd $(dirname $0); cd ..; pwd`

# Install bun
export BUN_INSTALL=$CACHE_DIR/bun
export PATH="$BUN_INSTALL/bin:$PATH"

if [ -f "$BUN_INSTALL"/bin/bun ]; then
  echo "------> Bun $(bun --version) is already installed"
else
  # NOTE: For now support latest version only
  curl -fsSL https://bun.sh/install | bash
fi

cat <<EOT > "$BUILD_DIR"/.bunfig.toml
[install.cache]
# the directory to use for the cache
dir = "$CACHE_DIR/bun/install/cache"
EOT

bun --version

# download dependencies
cd "$BUILD_DIR"
bun install

# give environment to later buildpacks
export | grep -E -e ' (PATH)='  > "$LP_DIR/export"
